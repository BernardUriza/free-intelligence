name: Deploy to Production (Digital Ocean)

# =============================================================================
# AURITY Production Deployment Pipeline
# =============================================================================
# Security: Pre-deploy integrity check, post-deploy validation
# Rollback: Tag-based versioning with manual rollback trigger
# =============================================================================

on:
  push:
    branches:
      - prod
  workflow_dispatch:
    inputs:
      rollback_to:
        description: 'Tag to rollback to (e.g., v0.1.5). Leave empty for normal deploy.'
        required: false
        type: string

concurrency:
  group: production-deploy
  cancel-in-progress: false  # NEVER cancel production deploys mid-flight

env:
  DROPLET_HOST: 104.131.175.65
  DROPLET_USER: root
  PROJECT_PATH: /opt/free-intelligence

jobs:
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # Phase 0: Pre-flight Integrity Check
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  integrity-check:
    name: Pre-flight Integrity Check
    runs-on: ubuntu-latest
    if: github.event.inputs.rollback_to == ''
    outputs:
      was_dirty: ${{ steps.check.outputs.was_dirty }}
    steps:
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DO_SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519_do
          chmod 600 ~/.ssh/id_ed25519_do
          ssh-keyscan -H $DROPLET_HOST >> ~/.ssh/known_hosts

      - name: Check Production Integrity
        id: check
        run: |
          echo "üîç Checking if production has unauthorized changes..."
          ssh -i ~/.ssh/id_ed25519_do -o StrictHostKeyChecking=no \
            $DROPLET_USER@$DROPLET_HOST << 'ENDSSH'
          cd /opt/free-intelligence

          DIRTY=false

          # Check for uncommitted changes
          if ! git diff --quiet 2>/dev/null; then
            echo "‚ö†Ô∏è  DIRTY: Uncommitted changes detected!"
            git diff --name-only
            DIRTY=true
          fi

          # Check for untracked files in critical dirs
          UNTRACKED=$(git ls-files --others --exclude-standard backend/ apps/ 2>/dev/null | head -10)
          if [ -n "$UNTRACKED" ]; then
            echo "‚ö†Ô∏è  DIRTY: Untracked files detected!"
            echo "$UNTRACKED"
            DIRTY=true
          fi

          if [ "$DIRTY" = true ]; then
            echo ""
            echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
            echo "‚õîÔ∏è PRODUCTION WAS DIRTY - RESETTING TO CLEAN STATE"
            echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
            git checkout -- .
            git clean -fd
            echo "‚úÖ Production reset to clean state"
            echo "was_dirty=true" >> /tmp/check_result
          else
            echo "‚úÖ Production is clean"
            echo "was_dirty=false" >> /tmp/check_result
          fi
          ENDSSH

          # Get result
          RESULT=$(ssh -i ~/.ssh/id_ed25519_do -o StrictHostKeyChecking=no \
            $DROPLET_USER@$DROPLET_HOST "cat /tmp/check_result 2>/dev/null || echo 'was_dirty=false'")
          echo "$RESULT" >> $GITHUB_OUTPUT

  deploy-frontend:
    name: Deploy Frontend (Next.js)
    runs-on: ubuntu-latest
    needs: integrity-check
    if: always() && (needs.integrity-check.result == 'success' || needs.integrity-check.result == 'skipped')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install dependencies (aurity only)
        run: pnpm install --filter aurity --frozen-lockfile

      - name: Build frontend
        env:
          NEXT_PUBLIC_BACKEND_URL: https://app.aurity.io
          NEXT_PUBLIC_API_BASE: https://app.aurity.io
        run: pnpm --filter aurity build

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DO_SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519_do
          chmod 600 ~/.ssh/id_ed25519_do
          ssh-keyscan -H $DROPLET_HOST >> ~/.ssh/known_hosts

      - name: List build output (debug)
        run: |
          echo "üìÅ Checking build output location..."
          find . -name "out" -type d 2>/dev/null | head -5
          ls -la apps/aurity/ || echo "apps/aurity/ not found"

      - name: Deploy to Digital Ocean
        run: |
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/id_ed25519_do -o StrictHostKeyChecking=no" \
            apps/aurity/out/ \
            $DROPLET_USER@$DROPLET_HOST:$PROJECT_PATH/apps/aurity/out/

      - name: Reload Nginx
        run: |
          ssh -i ~/.ssh/id_ed25519_do -o StrictHostKeyChecking=no \
            $DROPLET_USER@$DROPLET_HOST \
            "nginx -t && (systemctl is-active nginx && systemctl reload nginx || systemctl start nginx)"

  deploy-backend:
    name: Deploy Backend (Docker)
    runs-on: ubuntu-latest
    needs: deploy-frontend
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DO_SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519_do
          chmod 600 ~/.ssh/id_ed25519_do
          ssh-keyscan -H $DROPLET_HOST >> ~/.ssh/known_hosts

      - name: Sync backend code
        run: |
          rsync -avz --delete \
            --exclude '__pycache__/' \
            --exclude '*.pyc' \
            --exclude '.env*' \
            -e "ssh -i ~/.ssh/id_ed25519_do -o StrictHostKeyChecking=no" \
            backend/ \
            $DROPLET_USER@$DROPLET_HOST:$PROJECT_PATH/backend/

      - name: Sync packages (fi_common)
        run: |
          rsync -avz --delete \
            --exclude '__pycache__/' \
            --exclude '*.pyc' \
            -e "ssh -i ~/.ssh/id_ed25519_do -o StrictHostKeyChecking=no" \
            packages/ \
            $DROPLET_USER@$DROPLET_HOST:$PROJECT_PATH/packages/

      - name: Sync project files
        run: |
          rsync -avz \
            -e "ssh -i ~/.ssh/id_ed25519_do -o StrictHostKeyChecking=no" \
            requirements-prod.txt policy.yaml \
            $DROPLET_USER@$DROPLET_HOST:$PROJECT_PATH/

      - name: Install Python dependencies
        run: |
          ssh -i ~/.ssh/id_ed25519_do -o StrictHostKeyChecking=no \
            $DROPLET_USER@$DROPLET_HOST << 'ENDSSH'
          cd /opt/free-intelligence

          echo "üì¶ Installing pip if needed..."
          if ! python3 -m pip --version > /dev/null 2>&1; then
            apt-get update && apt-get install -y python3-pip
          fi

          echo "üíæ Setting up swap space if needed..."
          if [ ! -f /swapfile ]; then
            fallocate -l 2G /swapfile
            chmod 600 /swapfile
            mkswap /swapfile
            swapon /swapfile
            echo "‚úÖ Swap space created (2GB)"
          else
            echo "‚úÖ Swap space already exists"
          fi

          echo "üßπ Removing conflicting system packages..."
          apt-get remove -y python3-zope.interface python3-twisted || true

          echo "üì¶ Installing Python 3.14 if needed..."
          if ! python3.14 --version > /dev/null 2>&1; then
            apt-get update && apt-get install -y python3.14 python3.14-dev
          fi

          echo "üì¶ Bootstrapping pip for Python 3.14..."
          python3.14 -m ensurepip --upgrade 2>/dev/null || true

          echo "üì¶ Installing Python dependencies..."
          python3.14 -m pip install --upgrade pip
          python3.14 -m pip install -r requirements-prod.txt

          echo "‚úÖ Dependencies installed"
          ENDSSH

      - name: Rebuild and restart backend
        run: |
          ssh -i ~/.ssh/id_ed25519_do -o StrictHostKeyChecking=no \
            $DROPLET_USER@$DROPLET_HOST << 'ENDSSH'
          cd /opt/free-intelligence

          echo "üõë Stopping old backend process..."
          # Kill any process listening on port 7001 (more reliable than pkill pattern)
          fuser -k 7001/tcp || true
          sleep 2

          echo "üßπ Clearing Python bytecode cache..."
          find backend -type d -name '__pycache__' -exec rm -rf {} + 2>/dev/null || true
          find backend -type f -name '*.pyc' -delete 2>/dev/null || true

          echo "üöÄ Starting new backend..."
          cd /opt/free-intelligence
          PYTHONNOUSERSITE=1 nohup python3.14 -m uvicorn backend.app.main:app --host 0.0.0.0 --port 7001 > /tmp/backend.log 2>&1 &
          sleep 5

          echo "‚úÖ Backend deployed successfully"
          echo "üìù Last 100 log lines:"
          tail -100 /tmp/backend.log

          echo ""
          echo "üîç Verifying backend is running..."
          ps aux | grep uvicorn | grep -v grep || echo "‚ö†Ô∏è  Backend process not found"

          echo ""
          echo "üß™ Testing local backend connection..."
          sleep 3
          curl -s http://localhost:7001/api/health || echo "‚ùå Backend not responding locally"
          ENDSSH

  verify-deployment:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: deploy-backend
    steps:
      - name: Check frontend is serving
        run: |
          sleep 10  # Wait for backend to start
          curl -f https://app.aurity.io/ -o /dev/null || exit 1
          echo "‚úÖ Frontend is serving"

      - name: Check API sessions endpoint
        run: |
          curl -f https://app.aurity.io/api/workflows/aurity/sessions || exit 1
          echo "‚úÖ Backend API is responding"

      - name: Create Release Tag
        run: |
          # Auto-generate version tag
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          TAG="deploy-${TIMESTAMP}"
          echo "üè∑Ô∏è  Creating tag: $TAG"

          # This requires GITHUB_TOKEN with write access
          curl -s -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/git/refs \
            -d "{\"ref\":\"refs/tags/$TAG\",\"sha\":\"${{ github.sha }}\"}" || true

          echo "‚úÖ Tag created: $TAG"

      - name: Send success notification
        if: success()
        run: |
          echo "‚úÖ Deployment to production successful!"
          echo "üåê Frontend: https://app.aurity.io"
          echo "üîå Backend:  https://app.aurity.io/api/workflows/aurity/sessions"

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # Rollback Job (manual trigger with rollback_to input)
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  rollback:
    name: Rollback to Tag
    runs-on: ubuntu-latest
    if: github.event.inputs.rollback_to != ''
    steps:
      - name: Checkout at Tag
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.rollback_to }}
          submodules: recursive

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DO_SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519_do
          chmod 600 ~/.ssh/id_ed25519_do
          ssh-keyscan -H $DROPLET_HOST >> ~/.ssh/known_hosts

      - name: Execute Rollback
        run: |
          TAG="${{ github.event.inputs.rollback_to }}"
          echo "üîÑ Rolling back to $TAG..."

          ssh -i ~/.ssh/id_ed25519_do -o StrictHostKeyChecking=no \
            $DROPLET_USER@$DROPLET_HOST << ENDSSH
          cd $PROJECT_PATH

          echo "üì• Fetching tags..."
          git fetch --all --tags

          echo "üîÑ Checking out $TAG..."
          git checkout $TAG

          echo "üõë Restarting backend..."
          fuser -k 7001/tcp || true
          sleep 2
          PYTHONNOUSERSITE=1 nohup python3.14 -m uvicorn backend.app.main:app --host 0.0.0.0 --port 7001 > /tmp/backend.log 2>&1 &

          echo "üîÑ Reloading nginx..."
          nginx -t && nginx -s reload

          echo "‚úÖ Rolled back to $TAG"
          ENDSSH

      - name: Verify Rollback
        run: |
          sleep 10
          curl -f https://app.aurity.io/ -o /dev/null && echo "‚úÖ Rollback verified"
