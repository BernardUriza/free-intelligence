name: Deploy to Production (Digital Ocean)

on:
  push:
    branches:
      - prod
  workflow_dispatch:  # Allow manual triggers

env:
  DROPLET_HOST: 104.131.175.65
  DROPLET_USER: root
  PROJECT_PATH: /opt/free-intelligence

jobs:
  deploy-frontend:
    name: Deploy Frontend (Next.js)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install dependencies (aurity only)
        run: pnpm install --filter aurity --frozen-lockfile

      - name: Build frontend
        env:
          NEXT_PUBLIC_BACKEND_URL: https://app.aurity.io
          NEXT_PUBLIC_API_BASE: https://app.aurity.io
        run: pnpm --filter aurity build

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DO_SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519_do
          chmod 600 ~/.ssh/id_ed25519_do
          ssh-keyscan -H $DROPLET_HOST >> ~/.ssh/known_hosts

      - name: List build output (debug)
        run: |
          echo "üìÅ Checking build output location..."
          find . -name "out" -type d 2>/dev/null | head -5
          ls -la apps/aurity/ || echo "apps/aurity/ not found"

      - name: Deploy to Digital Ocean
        run: |
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/id_ed25519_do -o StrictHostKeyChecking=no" \
            apps/aurity/out/ \
            $DROPLET_USER@$DROPLET_HOST:$PROJECT_PATH/apps/aurity/out/

      - name: Reload Nginx
        run: |
          ssh -i ~/.ssh/id_ed25519_do -o StrictHostKeyChecking=no \
            $DROPLET_USER@$DROPLET_HOST \
            "nginx -t && systemctl reload nginx"

  deploy-backend:
    name: Deploy Backend (Docker)
    runs-on: ubuntu-latest
    needs: deploy-frontend
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DO_SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519_do
          chmod 600 ~/.ssh/id_ed25519_do
          ssh-keyscan -H $DROPLET_HOST >> ~/.ssh/known_hosts

      - name: Sync backend code
        run: |
          rsync -avz --delete \
            --exclude 'storage/' \
            --exclude 'export/' \
            --exclude '__pycache__/' \
            --exclude '*.pyc' \
            --exclude '.env*' \
            -e "ssh -i ~/.ssh/id_ed25519_do -o StrictHostKeyChecking=no" \
            backend/ \
            $DROPLET_USER@$DROPLET_HOST:$PROJECT_PATH/backend/

      - name: Sync project files
        run: |
          rsync -avz \
            -e "ssh -i ~/.ssh/id_ed25519_do -o StrictHostKeyChecking=no" \
            requirements-prod.txt policy.yaml \
            $DROPLET_USER@$DROPLET_HOST:$PROJECT_PATH/

      - name: Install Python dependencies
        run: |
          ssh -i ~/.ssh/id_ed25519_do -o StrictHostKeyChecking=no \
            $DROPLET_USER@$DROPLET_HOST << 'ENDSSH'
          cd /opt/free-intelligence

          echo "üì¶ Installing pip if needed..."
          if ! python3 -m pip --version > /dev/null 2>&1; then
            apt-get update && apt-get install -y python3-pip
          fi

          echo "üíæ Setting up swap space if needed..."
          if [ ! -f /swapfile ]; then
            fallocate -l 2G /swapfile
            chmod 600 /swapfile
            mkswap /swapfile
            swapon /swapfile
            echo "‚úÖ Swap space created (2GB)"
          else
            echo "‚úÖ Swap space already exists"
          fi

          echo "üßπ Removing conflicting system packages..."
          apt-get remove -y python3-zope.interface python3-twisted || true

          echo "üì¶ Installing Python 3.11 if needed..."
          if ! python3.11 --version > /dev/null 2>&1; then
            apt-get update && apt-get install -y python3.11 python3.11-venv python3.11-dev
          fi

          echo "üì¶ Bootstrapping pip for Python 3.11..."
          python3.11 -m ensurepip --upgrade 2>/dev/null || true

          echo "üì¶ Installing Python dependencies..."
          python3.11 -m pip install --upgrade pip
          python3.11 -m pip install -r requirements-prod.txt

          echo "‚úÖ Dependencies installed"
          ENDSSH

      - name: Rebuild and restart backend
        run: |
          ssh -i ~/.ssh/id_ed25519_do -o StrictHostKeyChecking=no \
            $DROPLET_USER@$DROPLET_HOST << 'ENDSSH'
          cd /opt/free-intelligence

          echo "üõë Stopping old backend process..."
          pkill -f uvicorn || true
          sleep 2

          echo "üöÄ Starting new backend..."
          cd /opt/free-intelligence
          PYTHONNOUSERSITE=1 nohup python3.11 -m uvicorn backend.app.main:app --host 0.0.0.0 --port 7001 > /tmp/backend.log 2>&1 &
          sleep 5

          echo "‚úÖ Backend deployed successfully"
          echo "üìù Last 100 log lines:"
          tail -100 /tmp/backend.log

          echo ""
          echo "üîç Verifying backend is running..."
          ps aux | grep uvicorn | grep -v grep || echo "‚ö†Ô∏è  Backend process not found"

          echo ""
          echo "üß™ Testing local backend connection..."
          sleep 3
          curl -s http://localhost:7001/api/health || echo "‚ùå Backend not responding locally"
          ENDSSH

  verify-deployment:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: deploy-backend
    steps:
      - name: Check health endpoint
        run: |
          sleep 10  # Wait for backend to start
          curl -f https://app.aurity.io/api/health || exit 1

      - name: Check API endpoint
        run: |
          curl -f https://app.aurity.io/api/workflows/aurity/sessions || exit 1

      - name: Send success notification
        if: success()
        run: |
          echo "‚úÖ Deployment to production successful!"
          echo "üåê Frontend: https://app.aurity.io"
          echo "üîå Backend:  https://app.aurity.io/api/"
          echo "üíö Health:   https://app.aurity.io/api/health"
