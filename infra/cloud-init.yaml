#cloud-config
# Free Intelligence - DigitalOcean NAS Droplet
# Provisions Ubuntu 22.04 with Block Storage + NFSv4 server
#
# Usage: doctl compute droplet create fi-nas \
#   --region nyc3 --size s-2vcpu-4gb --image ubuntu-22-04-x64 \
#   --vpc-uuid $VPC_UUID --user-data-file infra/cloud-init.yaml
#
# Block Storage: Attach via DO console, note UUID for fstab

package_update: true
package_upgrade: true

packages:
  - nfs-kernel-server
  - nfs-common
  - ufw
  - htop
  - tree
  - jq

# Create fi user with consistent UID/GID for NFS
users:
  - name: fi
    uid: 1000
    groups: [sudo, docker]
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']

# Write configuration files
write_files:
  # NFS exports configuration
  - path: /etc/exports
    content: |
      # Free Intelligence NFS Exports
      # VPC-only access (replace 10.116.0.0/20 with your VPC CIDR)
      /mnt/fi 10.116.0.0/20(rw,sync,no_subtree_check,no_root_squash,crossmnt)
    permissions: '0644'

  # NFS server tuning for HDF5 workloads
  - path: /etc/default/nfs-kernel-server
    content: |
      RPCNFSDCOUNT=8
      RPCNFSDPRIORITY=0
      RPCMOUNTDOPTS="--manage-gids"
      NEED_SVCGSSD=""
      RPCSVCGSSDOPTS=""
    permissions: '0644'

  # NFSv4 ID mapping (critical for UID/GID consistency)
  - path: /etc/idmapd.conf
    content: |
      [General]
      Verbosity = 0
      Domain = fi.local

      [Mapping]
      Nobody-User = nobody
      Nobody-Group = nogroup

      [Translation]
      Method = nsswitch
    permissions: '0644'

  # Sysctl tuning for NFS performance
  - path: /etc/sysctl.d/99-nfs-tuning.conf
    content: |
      # NFS server performance tuning
      net.core.rmem_max = 16777216
      net.core.wmem_max = 16777216
      net.ipv4.tcp_rmem = 4096 87380 16777216
      net.ipv4.tcp_wmem = 4096 65536 16777216
      net.core.netdev_max_backlog = 30000
      sunrpc.tcp_slot_table_entries = 128
    permissions: '0644'

  # FI environment overrides
  - path: /mnt/fi/.env.production
    content: |
      # Free Intelligence - Production Environment (DO NAS)
      # Auto-generated by cloud-init

      # Storage paths (Block Storage mounted at /mnt/fi)
      CORPUS_PATH=/mnt/fi/data/corpus.h5
      BACKUP_PATH=/mnt/fi/backups
      STORAGE_PATH=/mnt/fi/data
      TRIAGE_DATA_DIR=/mnt/fi/data/triage_buffers

      # Logging
      LOG_PATH=/mnt/fi/logs
      LOG_LEVEL=info

      # Node environment
      NODE_ENV=production
      NEXT_TELEMETRY_DISABLED=1
    permissions: '0644'

# Commands to run at first boot
runcmd:
  # Mount Block Storage (replace VOLUME_UUID with actual UUID)
  # Get UUID with: blkid /dev/disk/by-id/scsi-0DO_Volume_fi-data
  - |
    VOLUME_DEVICE="/dev/disk/by-id/scsi-0DO_Volume_fi-data"
    if [ -b "$VOLUME_DEVICE" ]; then
      # Format if new (only if not already formatted)
      if ! blkid "$VOLUME_DEVICE" | grep -q ext4; then
        mkfs.ext4 -F "$VOLUME_DEVICE"
      fi

      # Create mount point
      mkdir -p /mnt/fi

      # Add to fstab if not present
      if ! grep -q "/mnt/fi" /etc/fstab; then
        VOLUME_UUID=$(blkid -s UUID -o value "$VOLUME_DEVICE")
        echo "UUID=$VOLUME_UUID /mnt/fi ext4 defaults,nofail,discard 0 2" >> /etc/fstab
      fi

      # Mount
      mount -a
    fi

  # Create directory structure
  - mkdir -p /mnt/fi/{data,backups,logs,config}
  - chown -R 1000:1000 /mnt/fi
  - chmod 755 /mnt/fi

  # Apply sysctl tuning
  - sysctl --system

  # Configure and start NFS
  - systemctl enable nfs-kernel-server
  - systemctl restart nfs-idmapd
  - exportfs -ra
  - systemctl start nfs-kernel-server

  # Configure UFW (VPC CIDR: 10.116.0.0/20 - adjust as needed)
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow from 10.116.0.0/20 to any port 22 proto tcp comment 'SSH from VPC'
  - ufw allow from 10.116.0.0/20 to any port 2049 proto tcp comment 'NFSv4 from VPC'
  - ufw allow from 10.116.0.0/20 to any port 111 proto tcp comment 'RPC portmapper'
  - ufw --force enable

  # Verify NFS is exporting
  - exportfs -v

  # Log completion
  - echo "$(date): FI NAS cloud-init complete" >> /var/log/fi-nas-setup.log

final_message: |
  Free Intelligence NAS ready!
  - NFS export: /mnt/fi
  - Mount from client: mount -t nfs4 ${PRIVATE_IP}:/mnt/fi /mnt/fi-remote
  - Check status: exportfs -v && systemctl status nfs-kernel-server
